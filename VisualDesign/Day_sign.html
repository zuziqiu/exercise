<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>每日签到</title>
		<link rel="stylesheet" type="text/css" href="css/base.css"/>
		<link rel="stylesheet" type="text/css" href="css/style.css"/>
		<style>
			html,body,#main{
				background-color:#fff;
			}
			.sign_box{
				padding:10% 0 2.4444%;
				background:url(img/img_cloud.png) 0 0 no-repeat;
				background-size: 100%;
				text-align: center;
			}
			.title_img{
				width:73.22222%;
			}
			.tip{
				padding:3.444%;
				margin-top:3%;
				font-size:1em;
				display: inline-block;
				background-color:#ff7680;
				box-sizing: border-box;
				border-radius: 0.3rem;
				color:#fff;
				font-weight:bold;
			}
			.calendar{
				width:77.77778%;
				margin-top:10%;
				background-color:#ff7680 ;
				padding:0 2.444% 2.4444%;
				border-radius: 0.3rem;
				box-sizing: border-box;
				display: inline-block;
				
			}
			.top>img{
				width:100%;
			}
			td{
				border-radius: 50%;
				padding:4.244% 0;
			}
			.top>div{
				width:100%;
				height:1.8rem;
				text-align: center;
				color:#fff;
			}
			@media screen and (min-width:400px){
				#main{
					font-size:0.9rem;
				}
			}
			@media screen and (min-width:640px){
				#main{
					font-size:1.8rem;
				}
				.sign_box{
					padding-top:12.5%;
				}
				.tip{
					padding:1.4444%;
				}
				.top>div{
					height:4rem;
				}
			}
			
			@media screen and (max-width:325px){
				#main{
					font-size:0.7rem;
				}
				.tip{
					margin-top:2%;
					padding:3.444% 1.4444%;
				}
			}

			.bill_query_menu{
				overflow:hidden;
				text-align: center;
				padding: 5%;
				font-size:150% ;
			}

			.bill_query_content_menu_one{
				margin-top: 9px;
				margin-left: 5%;
				background:#f3f5f5 ;
				width: 90%;
				height: 30px;
				line-height: 30px;
				border:1px #f3f5f5 solid;
				border-radius:5px;
			}

			.bill_query_one{
				float: left;
				margin-left:4%;
			}

			.bill_query_two{
				float: right;
				margin-right: 26%;
			}

			.bill_query_three{
				float: left;
				margin-left:8%;
			}

			.bill_query_content_menu_two{
				width: 90%;
				display: inline-flex;
				display: -webkit-inline-flex;
				margin-left: 5%;
			}
			.bill_query_content_menu_two span{
				color: #959595;
				flex: 1;
				text-align: center;
			}
			.bill_query_number_color{
				color: #10afff;
				font-size: 400%;
				width: 90%;
				margin-left: 5%;
				display: inline-flex;
				display: -webkit-inline-flex;
			}

			.bill_query_number_color span{
				flex: 1;
				text-align: center;
			}

			.money_db{
				border-bottom:1px solid #f0f0f0;
				padding:4% 4.444%;
				overflow: hidden;
			}

			.money_num{
				top:50%;
				margin-left: 10%;
				float:left;
			}

			.db_cz{
				float: right;
				top: 50%;
				margin-right: 20%;
			}
			.bill_menu:first-child{
				color:rgb(16, 174, 255);
				border-bottom: 2px solid rgb(16, 174, 255);
				padding-bottom: 10px;
			}

			.bill_menu{
				color: #c3c3c3;
			}

			#bill_menu_two{
				margin-left: 20%;
			}
			.tnav~*:nth-child(2) {
			    margin-top: 10%;
			}
			@media only screen and (min-width: 550px){
				.tnav~*:nth-child(2){
					padding-top: 13%;
					margin-top: 8%;
					background-color: #FFFFFF;
				}
			}
			@media only screen and (min-width: 380px) and (max-width: 549px) {
				.tnav~*:nth-child(2){
					padding-top: 14%;
					
					background-color: #FFFFFF;
				}
			}
			/*新增结果窗口样式*/
		.show{
			/*display: none;*/
			text-align: center;
			width: 100%;
			padding-top: 70%;
			padding-bottom: 130%;
			position: fixed;
		   	top:0;
		   	background-color: rgba(0,0,0,0.1);
		   	z-index: 99;
		}
		.show>div {
			width: 53%;
			background-color: rgba(0,0,0,0.7);
		}
		.save_success{
		   	text-align: center;
		   	font-size: 18px;
			color: #000000;
			padding-top: 3%;
			padding-bottom: 3%;
			border-radius: 100px;
			color: #FFFFFF;
			font-weight: bold;
			margin-left: auto;
			margin-right: auto;
		}
		</style>
	</head>
	<body>
		<div id="main">
			<div class="tnav col">
				<b class="arrow"><span class="ic_leftarrow" data-url="index.html"></span> 每日签到</b>
				<span class="backmain ic_home"></span>
			</div>
			<div class="sign_box">
				<img class="title_img" src="img/img_text_qiandao.png" alt="" /><br />
				<div class="calendar">
					<div class="top">
						<img src="img/bg04.png" alt="" />
						<div class="pstion">
							<span class="pstion_day"></span><br />
							<small class="time"></small>
						</div>
					</div>
					<table class="bodier" style="background-color:#fff;width:100%;padding-bottom:4.4444%">
						<tr class="top" style="color:#ababab">
							<td>日</td>
							<td>一</td>
							<td>二</td>
							<td>三</td>
							<td>四</td>
							<td>五</td>
							<td>六</td>
						</tr>
					</table>
				</div>
			</div>

			<div class="bill_query">
				<div class="bill_query_menu">
					<span class="bill_menu" id="bill_menu_one">签到赠送说明</span>
					<span class="bill_menu" id="bill_menu_two" style="border: none;">签到查询</span>
				</div>
			<!--/菜单-->

				<div class="bill_query_main">

					<!--签到赠送说明-->
					<div class="bill_query_content_chongzhi">
						<div class="bill_query_content_menu_one">
							<div class="bill_query_one">连续天数</div>
							<div class="bill_query_two">奖励</div>
							<br>
						</div>
						<div id="view">
							<script type="text/html" id="info">
								{{# for(var i = 0, len = d.Data2.length; i < len; i++){ }}
								<div class="bill_query_list">
									<div class="money_db">
										<div class="money_num">{{d.Data2[i].Key}}</div>
										<div class="db_cz">{{d.Data2[i].Value}}</div>
									</div>
								</div>
								{{# } }}
							</script>
						</div>
					</div>
					<!--/签到赠送说明-->

					<!--签到查询-->
					<div class="bill_query_content_jitai" hidden="">
						<div class="bill_query_content_menu_two">
							<span class="bill_query_lei">累计签到</span>
							<span class="bill_query_lian">连续签到</span>
							<span class="bill_query_jiang">累计奖励</span>
							<br>
						</div>
						<div class="bill_query_number_color">
							<span class="bill_query_number_one"></span>
							<span class="bill_query_number_two"></span>
							<span class="bill_query_number_three"></span>
						</div>

						<div class="bill_query_content_menu_one">
							<span class="bill_query_three">签到日期</span>
							<span class="bill_query_two">奖励</span>
						</div>
						<br>
						<div id="view2">
							<script type="text/html" id="info2">
								{{# for(var i = 0, len = d.Data.length; i < len; i++){ }}
								<div class="bill_query_list">
									<div class="money_db">
										<span class="money_num">{{d.Data[i].Date}}</span>
										<span class="db_cz">{{d.Data[i].Info}}</span>
									</div>
								</div>
								{{# } }}
							</script>
						</div>
					</div>
					<!--/签到查询-->
				</div>
			</div>    
		</div>
		<div class="sh_loading">
		  		<div class="loading_mengceng"></div>
			<div class="loadEffect">
			    <span></span>
			    <span></span>
			   	<span></span>
			    <span></span>
			    <span></span>
		  		<span></span>
			    <span></span>
			    <span></span>
				<!--<p class="loading_tips">正在加载中</p>-->
			</div>
		</div>
		<div id="show2" class="show" hidden="">
			<div class="save_success" hidden="">已经到最底了</div>
		</div>
		<script src="js/jquery-1.12.2.min.js" type="text/javascript"></script>
		<script src="js/base.js" type="text/javascript"></script>
		<script src="js/laytpl.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var record_day=[];
			function calendar(){
				var today = new Date();
				var year,thisMonth,thisWeek,thisDay;
				var monthDays = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
				var dayNames = new Array("星期日","星期一","星期二","星期三","星期四","星期五","星期六");
				year = today.getFullYear();//年
				thisMonth = today.getMonth()+1;//月
				thisWeek = today.getDay();//星期
				thisDay = today.getDate();//天
				
				//console.log(thisMonth);
				if (((year % 4 == 0) && (year % 100 != 0)) || (year % 400 == 0)){monthDays[1] = 29;}
				var nDays = monthDays[today.getMonth()];
				var firstDay = today;		
				firstDay.setDate(1);
				var startDay = firstDay.getDay();
				$(".time").html(year+"-"+thisMonth);
				var colnum = 0;
				var record=0;
				var txt="<tr class='top' style='color:#ababab'><td>日</td><td>一</td><td>二</td><td>三</td><td>四</td><td>五</td><td>六</td></tr>\n<tr style='font-weight:bold'>"
				for(var i=0;i<startDay;i++){
					txt += "\n<td></td>"
					colnum++;
				}
				for(var i=1; i<=nDays; i++){
				
					if (i == record_day[record]||i == thisDay) {
						//console.log(record_day)
						if (i == thisDay&&i == record_day[record]) {
							txt += "\n<td style='background-color:#ffbe00;color:#fff'>"+i+"<img style='width:40%;position:absolute;bottom:0;right:5%;margin-bottom:10%;' src='img/ic_check.png' alt='' /></td>";
						}else if(i == thisDay){
							txt += "\n<td style='background-color:#ffbe00;color:#fff'>"+i+"</td>";
							
						}else{
							txt += "\n<td>"+i+"<img style='width:40%;position:absolute;bottom:0;right:5%;margin-bottom:20%;' src='img/ic_check.png' alt='' /></td>";
						}
						record++;
					}
					else {
						txt += "\n<td>"+i+"</td>";
					}
					colnum++;
					if (colnum == 7) {
						if(i==nDays){
							txt += "\n</tr>"
						}
						else{
							txt += "\n</tr>\n<tr style='font-weight:bold'>"
							
						}
						colnum = 0;
					}
					if(i==nDays){
						//console.log(txt);
						$(".bodier").html(txt);	
					}
				}
//				console.log(txt,nDays);
			}
				
//		calendar();
		</script>
		
		<script type="text/javascript">
		var record_day = [];
		var index = null;
		var PageIndex = 1;		//查询页数
		var Total;				//数据长度
		var gettp2 = document.getElementById('info2').innerHTML;;				//被渲染结构
		var datas={Data:[]};
			myajax({
				"cache-control": "no-cache",
				"postman-token": "d0e32ffb-d5a2-0f6f-d64f-66e3a0078a0a",
				"data": {
						    "UserId": "46E19176-D96C-45CD-A05D-3B777A25191F",
						    "_api" :"SignIn/SignIn",
					},
				
			},'successfn1');
			
			//		判断异步请求相关回调函数
			function successfn(response,action){
				if(action=='successfn1'){
					successfn1(response);
					}
					
				if(action=='successfn2'){
					successfn2(response);
					}
				
				if(action=='successfn3'){
					successfn3(response);
				}
			}
			
			
			function successfn1(response){
				var sign = JSON.parse(response);
				
				//连续签到
				var accumulate = sign.Data[0].Message;
				var length = accumulate.length-12;
//				accumulate = accumulate.substr(6,length);
//				$(".pstion>span").html(accumulate);
				myajax({
					"cache-control": "no-cache",
					"postman-token": "d0e32ffb-d5a2-0f6f-d64f-66e3a0078a0a",	
				"data": {
						    "UserId": "46E19176-D96C-45CD-A05D-3B777A25191F",
						    "_api" :"SignInList/SignInList",
					},								
				},'successfn2');
			
			}
			//成功访问后台返回的数据
			function successfn2(response){
				var data = JSON.parse(response);
				index =  data.Data;
				$(".tip").html("您已累计签到"+index.length+"天，超越了98%的用户");
				var	_time =  new Date();
				var year = _time.getFullYear();//年
				var thisMonth = _time.getMonth()+1;//月
				//获取具体哪一天签到时间
				data.Data.forEach(function(gt){
					var str = gt.Date;
					//console.log(str);
					var _year = str.substr(0,4);
					var _thisMonth = str.substr(5,2);
					str = str.substr(8,2);
					if(_thisMonth<10){
						_thisMonth = _thisMonth.substr(1,1);
					}else{
						_thisMonth;
					}
					//console.log(_year);
					//判断是否是当前年月
					if(year == _year && thisMonth == _thisMonth){
						record_day.push(str);
					}else{
						record_day = [];
					}
					//console.log(str);
					calendar();
				});
			}


		$.ajax({
			method: "POST",
			async:"true",
			crossDomain:"true",
			url: "http://test3.msqsoft.net/zkweixin/weiphp/index.php?s=api",
			headers: {
				"Authorization": "Basic QXBpQmFzaWM6MTIz",
				"cache-control": "no-cache",
				"postman-token": "3af1c358-6705-9515-ebd6-241b5a8b8e8b",
				"Content-Type": "application/x-www-form-urlencoded"
			},
			data: {
				"UserId": "46E19176-D96C-45CD-A05D-3B777A25191F",
				"BranchId": "3D7775B5-33D1-4348-B3AA-4CFD9AEEC0D2",
				"_api": "SignInPresent/SignInPresent"
			},
			success: function(response) {
				$(".sh_loading").hide();
				var data = JSON.parse(response);
				$(data).each(function(index, elem){
//                        获取数据
//                    console.log(data);

					for(var i=0;i<=data.Data2.length;i++){
						$('.bill_query_number_three').html(i);
					}

					var gettpl = document.getElementById('info').innerHTML;
					laytpl(gettpl).render(data, function(html){
						document.getElementById('view').innerHTML = html;
					});
				})
			},
		});
		function showList(){
			$.ajax({
				method: "POST",
				async:"true",
				crossDomain:"true",
				url: "http://test3.msqsoft.net/zkweixin/weiphp/index.php?s=api",
				headers: {
					"Authorization": "Basic QXBpQmFzaWM6MTIz",
					"cache-control": "no-cache",
					"postman-token": "0228dd74-2755-5bf6-7738-c16ed7e4745e",
					"Content-Type": "application/x-www-form-urlencoded"
				},
				data: {
					"UserId": "FCFB223A-B017-45A9-A8DC-02D45B122E00",
					"BranchId": "3D7775B5-33D1-4348-B3AA-4CFD9AEEC0D2",
					"PageIndex": PageIndex,
	   				"PageSize": "10",
					"_api": "SignInPresentList/SignInPresentList"
				},
				success: function(response) {
					setTimeout(function(){
						$(".sh_loading").hide();
					},800)
					var data = JSON.parse(response);
					Total = data.Total;
					$(data).each(function(index, elem){
						$('.bill_query_number_one').html(data.Data2.TotalCount);
						$('.bill_query_number_two').html(data.Data2.Continuity);
						$('.pstion_day').html("您已连续签到"+data.Data2.Continuity+"次");
					})
					
					for(var i=0; i < data.Data.length; i++){
						datas.Data.push(data.Data[i]);
					}
					laytpl(gettp2).render(datas, function(html){
						document.getElementById('view2').innerHTML = html;
					});
				},
			});
		}
		showList();
		
		//声明
		var scrollTop,scrollHeight,windowHeight,selHeight,x1,x2,x3;
		//拉下加载更多	
		$(window).scroll(function(){
			if($("#bill_menu_two").css("color")=="rgb(16, 174, 255)"){		//限定查询签到选项
				scrollTop = $(this).scrollTop();
				scrollHeight = $(document).height();
				windowHeight = $(this).height();
				if(scrollTop + windowHeight == scrollHeight){
					PageIndex = PageIndex+1;
					$("html").on("touchstart",function(){
						x1=event.changedTouches[0].clientY;
						$(this).on("touchmove",function(){	
							x2=event.changedTouches[0].clientY;
							x3=x2-x1;
						}).on("touchend",function(){
							if(x3<-100&&scrollHeight - scrollTop - windowHeight <=100){
								if(PageIndex>1&&Total==$(".bill_query_list").last().index()+1){
									$("#show2,.save_success").show();
									setTimeout(function(){
										$("#show2,.save_success").hide();
									},2000);
								}
							}
							x1=0;x2=0;x3=0;		//重置滑动距离
						})
					})
					if(PageIndex>1&&Total==$("#view2 > div").last().index()+1){return};		//判断加载完最后一条数据时中断
					showList();
				}
			}
		});
		$(".bill_menu").click(function () {		//切换按钮
			$(this).css({"color":"rgb(16, 174, 255)","border-bottom":"2px solid rgb(16, 174, 255)","padding-bottom": "10px"}).siblings().css({"color":"#c3c3c3","border-bottom":"none"})
			$(".bill_query_main").children().eq($(this).index()).show().siblings().hide();
		});
		</script>
	</body>
</html>
