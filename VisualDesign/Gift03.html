<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>确认兑换</title>
		<link rel="stylesheet" href="css/style.css" />
		<link rel="stylesheet" href="css/base.css" />
		<link rel="stylesheet" type="text/css" href="css/Ga_Gi.css"/>
		<style type="text/css">
			html,body{
				background-color: #FFFFFF;
			}
			.fz{
				font-size:1rem;
				color:#666;
			}
			.sel,.go{
				background-color:#fff;
			}
			.sel2>img{
				width: 79px;
				height: 80px;
				border: none;
			}
			.go>li,.sel>:nth-child(n){
				padding:4.44444% 6.44444%;
				border-bottom:1px solid #f0f0f0;
			}
			.sel>:last-child{
				border-bottom:none;
			}
			.sel>:nth-child(1)>:nth-child(n){
				float:left;
				margin-right:5%;
			}
			.go>li>div,.sel2>div{
				height:1rem;
			}
			
			/*兑换方式样式*/
			
			.exchange_method_main,.distribution_mode_main{
				position: fixed;
				top: 30%;
				z-index: 100;
				background-color: #FFFFFF;
				width: 87.111%;
				margin: auto 6.444%;
				padding: 0;
			}
			.mengceng{
				background-color:#000000; opacity:0.1;filter:alpha(opacity=50);
				width: 100%;
				padding-bottom:177%;
			}
			
			.exchange_method,.distribution_mode{
				position: fixed;
				z-index: 99;
				width: 100%;
				top: 0;
			}
			.weui-select {
				padding-right: 30px;
			    -webkit-appearance: none;
			    border: 0;
			    outline: 0;
			    font-size: inherit;
			    line-height: 44px;
			    padding-left: 20px;
			    padding-right: 30px;
			    background-color: transparent;
			}
			.weui-select > div{
				border-bottom: 1px solid #F0F0F0;
			}
			.weui-select div:last-child{
				border-bottom: none;
			}
			.weui-select >div {
				width: 100%;
				height: 44px;
			}
			.weui-select > div >div{
				float: left;
				margin-left: 3px;
			}
			.weui-select span{
				color:dodgerblue;
				font-size: 17px;
				font-weight: bold;
				float: right;
				margin-right: 3px;
			}
			input{
				border: none;
				outline: none;
				float: right;
				width: 38px;
				font-size: 1rem;
				text-align: right;
			}
			.igs{
				float: right;
				margin-left: 5px;
			}
			.total{
				font-size: 1rem;
			}
			
			.buys{
				padding-top: 4%;
				padding-bottom: 3.5%;
				/*left: 50%;
				margin-left: -207px;	*/
				text-align: center;
			    width: 100%;
			    background-color: #10aeff;
			    color: #fff;
			    font-size: 1.2rem;
			    border-radius: 0.3rem;
			}
			
			/*动态插入地址的样式*/
			h2{
				line-height: 2rem;
				font-size: 1.2rem;
				margin-top: -2%;
			}
			#main{
				background-color:#fff;
			}
			.sel>:nth-child(n){
				padding:4.44444% 6.44444%;
			}

			.sel .sel2,.sel1>:nth-child(n){
				background-color:#fff;
				transition:0.5s all;
			}
			.col{
				font-size: 13px;
			}
			#view .sel2{
				overflow: visible;
			}
			#view .sel2>div{
				margin: 0;
				position: absolute;
			    top: 50%;
			    margin-top: -7px;
			}
			
			/*提示样式*/
	    	.show{
	    		/*display: none;*/
	    		text-align: center;
	    		width: 100%;
	    		padding-top: 70%;
	    		padding-bottom: 130%;
	    		position: fixed;
	    		top:0;
	    		background-color: rgba(0,0,0,0);
	    		z-index: 99;
	    	}
	    	.show>div{
	    		width:53%;
	    		background-color:rgba(0,0,0,0.7);
	    	}
	    	.cashing_success{
	    		text-align: center;
	    		font-size: 18px;
				color: #000000;
				padding-top: 3%;
				padding-bottom: 3%;
				border-radius: 100px;
				color: #FFFFFF;
				font-weight: bold;
				margin-left: auto;
				margin-right: auto;
	    	}
	    	.cashing_fail{
	    		font-size: 18px;
				color: #000000;
				padding-top: 3%;
				padding-bottom: 3%;
				border-radius: 100px;
				color: #FFFFFF;
				font-weight: bold;
				margin-left: auto;
				margin-right: auto;
	    	}
	    	#view > .sel2 >div{
	    		right: 0;
	    	}
	    	@media only screen and (min-width: 451px) and (max-width: 690px) {
		   		form{
		  			padding-top: 11% !important;
		  		}
		   	}
		   	@media only screen and (max-width: 450px) {
		   		form{
		  			padding-top: 10% !important;
		  		}
		   	}
		   	@media only screen and (max-width: 374px) {
		   		#main{
		   			height: 130%;
		   		}
		   		form{
		  			padding-top: 12% !important;
		  		}
		   	}
		  	@media only screen and (min-width: 700px) {
		  		form{
		  			padding-top: 7% !important;
		  		}
		   	}	
		</style>
	</head>
	<body>
		<div id="main">
			<div class="tnav col">
				<b class="arrow"><span class="ic_leftarrow" data-url="Gift02.html"></span> 确认兑换</b>
				<span class="backmain ic_home"></span>
			</div>
			<form action="">
				<ol class="go fz" data-url="Address01.html">
					<li class="address_tips" hidden="">
						暂未设置收货地址，去设置
						<div>
							<span class="rang ic_rightarrow"></span>
						</div>
					</li>
					<!--绑定地址数据-->
					<li id="view" class="view_sh" hidden="">
						<script type="text/html" id="model">
								<li class="sel2">
									<ol>
										<h2>{{d.Name}}-{{d.Phone}}</h2>
										<li class="col">
											{{d.AreaAddress}}
										</li>
										<li class="col">
											{{d.DetailAddress}}
										</li>
									</ol>
									<div>
										<span class="rang ic_rightarrow"></span>
									</div>
								</li>
						</script>
					</li>
				</ol>
				<ol class="sel">
					<li class="sel2">
						<img src="img/m01.png" alt="" />
						<ol>
							<h2 style="margin:0.3rem 0 1rem;color:rgba(252,252,252,0)">*</h2>
							<li class="col">
								<span class="ic_token"></span>
								积分: <span></span><span class="Gift02_Point"></span>
							</li>
							<li class="col">
								<span class="ic_lotterytickets"></span>
								彩票: <span class="Gift02_Tickets"></span>
							</li>
						</ol>
					</li>
					<li class="sel2 fz">
						兑换数量
						<small>(库存:<span class="Gift02_Qty" style="color: #252,252,252,0;">*</span>)</small>
						<div class="btn1" style="height:2rem;">
							<img src="img01/circle-minus.svg"/ alt="">
							<h2>0</h2>	
							<img src="img01/circle-plus.svg"/ alt="">
						</div>
					</li>
					<li class="sel2 fz">
						兑换方式
						<div><input class="ig" value=""><span class="rang ic_rightarrow" style="padding-left: 100%;display: block;z-index: 99;padding-top: 10px;padding-bottom: 10px;top: 50%;margin-top: -18px;"></span></div>
					</li>
					
					<li class="sel2 fz">
						配送方式
						<div><input class="db" value="自取"><span class="rang ic_rightarrow" style="padding-left: 100%;display: block;z-index: 99;padding-top: 10px;padding-bottom: 10px;top: 50%;margin-top: -18px;"></span></div>
					</li>
					<li class="sel2 fz">
						合计费用
						<div><div class="igs"></div><span style="color:#f43530" class="total">0</span></div>
					</li>
					<li class="sel2"style="position: fixed;width: 87.11112%;bottom: 0;">
						<p class="buys" >确认兑换</p>
					</li>
				</ol>	
			</form>
				<!--弹出选择兑换方式-->
				<div class="exchange_method" hidden="">
					<div class="mengceng"></div>
					<div class="distribution_mode_main">
				        <div class="weui-select" name="select1">
				            <!--ExchangeCoins-->
				            <div hidden="">
				            	<div>币1</div><span hidden="">√</span>
				            </div>
				            <!--ExchangeCoins2--> 
				            <div hidden="">
				            	<div>币2</div><span hidden="">√</span>
				            </div>
				            <!--ExchangeTickets--> 
				            <div>
				            	<div>彩票</div><span hidden="">√</span>
				            </div>
				            <!--ExchangePoint-->
				            <div>
				            	<div>积分</div><span hidden="">√</span>
				            </div>
				        </div>
					</div>
				</div>
				<!--/弹出选择兑换方式-->
				<!--弹出选择配送方式-->
				<div class="distribution_mode"  hidden="">
					<div class="mengceng"></div>
					<div class="exchange_method_main">
						<div class="weui-select" name="select1">
					        <div>
				            	<div>自取</div><span >√</span>
				            </div>
				            <div>
				            	<div>通知</div><span hidden="">√</span>
				            </div>
				            <div>
				            	<div>邮寄</div><span hidden="">√</span>
				            </div>
				        </div>
					</div>
				</div>
				<!--/弹出选择配送方式-->
				<!--绑定会员卡提示-->
			<div id="show2" class="show" hidden="">
					<div class="cashing_success"  hidden="">兑换成功</div>
					<div class="cashing_fail" hidden="">会员账户余额不足</div>
					<div class="cashing_fail" hidden="">兑换方式不能为0</div>
					<div class="cashing_fail" hidden="">请设置收货地址</div>
					<div class="cashing_fail" hidden="">兑换数量不能为0</div>
			</div>
		</div>
		<!--loading-->
		<div class="sh_loading">
			<div class="loading_mengceng"></div>
			<div class="loadEffect">
			    <span></span>
			    <span></span>
			   	<span></span>
			    <span></span>
			    <span></span>
			    <span></span>
			    <span></span>
			    <span></span>
				<!--<p class="loading_tips"></p>-->
			</div>
		</div>
		<script src="js/jquery-1.12.2.min.js" type="text/javascript"></script>
		<script type="text/javascript" src="js/laytpl.js" ></script>
		<script src="http://cdn.bootcss.com/blueimp-md5/1.1.0/js/md5.min.js"></script>  
		<script src="js/base.js" type="text/javascript"></script>
		<script type="text/javascript">
			//声明(计算数量)
		   	var count=0;
			//接收ProductID
			var getval=document.cookie.split(";")[0].split("=")[1];
			//计算总额方式
			var ExchangeCoins,ExchangeCoins2,ExchangeTickets,ExchangePoint;
			//设置兑换方式
			var Type = 2;
			//设置配送方式
			var Receive = 0;
			
			//声明(判断是否有收货地址)
			var Address,
				Phone,
				Contact;
				
			//获取链接
			var url = location.href;
			var index=0;
			
			if(!!url.split("?")[1]){		//判断地址下标
				index = url.split("?")[1];
			}else{
				$(".address_tips").show();		//显示收货地址(未有收货地址)
			}
			
			
			$(".btn1>img").eq(0).click(function(){
				if(count>0){
					count--;
					$(".btn1>h2").html(count);
				}
			})
			$(".btn1>img").eq(1).click(function(){
				if(count<8){
					count++;
					$(".btn1>h2").html(count);
				}
			})	
			
			
			var cashing_Coins,cashing_Coins2,cashing_Tickets,cashing_Point;
				
			//获取资产信息	
			myajax({ 
				    "cache-control": "no-cache",
				    "postman-token": "304a25c1-ae8f-a9b2-5dda-4cccdde0f2ff",
				data: {
					"_api":"member_info_by_wechat/GetCustomerInfo",
				    "WechatId": "ospcgwllZQ98DVrhiKhaVcEjL6zc",
				    "BranchId": "3D7775B5-33D1-4348-B3AA-4CFD9AEEC0D2",
				    "Telephone": "",
				    "CustomerNo": "",
					}
			},"successfn4");
			
			function successfn4(response){
				var bq_information = JSON.parse(response);
				bq_information.Data.forEach(function(bq_binding){
					cashing_Coins = bq_binding.Coins;
					cashing_Coins2 = bq_binding.Coins2;
					cashing_Tickets = bq_binding.Tickets;
					cashing_Point = bq_binding.Point;
				})
			};

			
			//弹出提示
			$(".mengceng").click(function(){
				$(".exchange_method").hide();
				$(".distribution_mode").hide();
			});
			
			$(".sel .sel2").eq(2).click(function(){
				$(".exchange_method").show();
			});
			
			$(".sel .sel2").eq(3).click(function(){
				$(".distribution_mode").show();
			});
			
			
			//兑换方式
			$(".exchange_method .weui-select > div ").click(function(){
				$(".exchange_method").hide();
				
				//商品兑换所需资产为0的方式不允许选择
				if($(this).index()==2&&ExchangeTickets==0){
					$(".show").show();
					$(".cashing_fail").eq(1).show();
					cashing_sh();
					return
				}
				if($(this).index()==3&&ExchangePoint==0){
					$(".show").show();
					$(".cashing_fail").eq(1).show();
					cashing_sh();
					return
				}
				
		    	var a =$(".exchange_method .weui-select > div > div" ).eq($(this).index()).text();
		    	$(".ig").val(a);
		    	$(".igs").text(a);
		    	$(".exchange_method .weui-select > div > span" ).hide();
		    	$(".exchange_method .weui-select > div > span" ).eq($(this).index()).show();
		    	$(".ig").val()=="币1"?Type = 0:$(".ig").val()=="币2"?Type = 1:$(".ig").val()=="彩票"?Type = 2:$(".ig").val()=="积分"?Type = 3:null;
//		    	console.log(Type)
			});
			
			//配送方式
			$(".distribution_mode .weui-select > div ").click(function(){
				$(".distribution_mode").hide();
		    	var b =$(".distribution_mode .weui-select > div > div" ).eq($(this).index()).text();
		    	$(".db").val(b);
		    	$(".distribution_mode .weui-select > div > span" ).hide();
		    	$(".distribution_mode .weui-select > div > span" ).eq($(this).index()).show();
				$(".db").val()=="自取"?Receive = 0:$(".db").val()=="通知"?Receive = 1:$(".db").val()=="邮寄"?Receive = 2:null;
//		    	console.log(Receive)
			});	
			
//			获取商品信息
			myajax({ 
				"cache-control": "no-cache",
			    "postman-token": "41e18e22-43c9-f866-e559-af4b001e3538",
				data: {
					"_api":"GiftList/GetGiftDetail",
				    "ProductID": getval,
    				"UserId": "2C1CB150-9F1B-431D-A72F-93BB549631E3"
				}
			},"successfn1");
			
			//获取商品信息回调函数
		    function successfn1(response){
		    	var gift = JSON.parse(response);
		    	gift.Data.forEach(function(gt){
		    		$(".sel2 > img").attr("src",gt.ImagePath);
			    	$(".sel2 ol h2").text(gt.Name).css("color","#000000");
			    	$(".Gift02_Point").text(gt.ExchangePoint).css("color","#a5a5a5");
			    	$(".Gift02_Tickets").text(gt.ExchangeTickets).css("color","#a5a5a5");
			    	$(".Gift02_Qty").text(gt.Qty).css("color","#a5a5a5");
			    	ExchangeCoins = gt.ExchangeCoins;
			    	ExchangeCoins2 = gt.ExchangeCoins2;
			    	ExchangeTickets = gt.ExchangeTickets;
			    	ExchangePoint = gt.ExchangePoint;
		    	});
		    	
		    	if(ExchangeTickets!=0){		//设置默认的兑换方式（与后台约定）
					$(".ig").val("彩票")
					$(".igs").text("彩票")
					$(".distribution_mode_main").find(".weui-select").children().eq(2).children("span").show()
					type=2;
				}else{
					$(".ig").val("积分")
					$(".igs").text("积分")
					$(".distribution_mode_main").find(".weui-select").children().eq(3).children("span").show()
					Type=3;
				}
				//获取所有收货地址信息
			    myajax({
					'data':{
						"CustID": "46E19176-D96C-45CD-A05D-3B777A25191F",
						"_api": "Customer/GetCustomerAddressList",
						}
				},'successfn3');
		    }
		    
			//总额运算
			$(".btn1 img,.weui-select>div").click(function(){
				$(".ig").val()=="币1"?$(".total").text(($(".btn1 h2").text()*ExchangeCoins)):
				$(".ig").val()=="币2"?$(".total").text(($(".btn1 h2").text()*ExchangeCoins2)):
				$(".ig").val()=="彩票"?$(".total").text(($(".btn1 h2").text()*ExchangeTickets)):
				$(".ig").val()=="积分"?$(".total").text(($(".btn1 h2").text()*ExchangePoint)):null;
			});

			//获取所有收货地址信息回调函数
			function successfn3(response){
//				console.log(index)
				var Gift_address = JSON.parse(response);
				if(Gift_address.Data.length>0){
					//获取收货人信息
					Address = Gift_address.Data[index].AreaAddress+Gift_address.Data[index].DetailAddress;
					Phone = Gift_address.Data[index].Phone;
					Contact = Gift_address.Data[index].Name;
					
					//fn3 Dom操作
					$(".address_tips").hide();
					$(".view_sh").show();
					var gettpl = document.getElementById('model').innerHTML;
					laytpl(gettpl).render(Gift_address.Data[index], function(html){
						document.getElementById('view').innerHTML = html;
					});
				}else{
						$(".address_tips").show();		//显示收货地址(有收货地址)
						$(".view_sh").hide();
				}
				
					
				//确认兑换
				$(".buys").click(function(){
					//判断收货人信息齐全
					if(Address==null||Phone==null||Contact==null){
						console.log("收货人信息未收集")
						$(".show").show();
						$(".cashing_fail").eq(2).show();
						cashing_sh();
						return
					}
					var number_submitted = $(".btn1 h2").text();
					//判断兑换数量
					if(number_submitted<1){
						$(".show").show();
						$(".cashing_fail").eq(3).show();
						cashing_sh();
						return
					}
					//判断兑换方式的资产余额信息
					if(Type==0){
						if(!($(".igs").siblings().text()<cashing_Coins)){
							$(".show").show();
							$(".cashing_fail").eq(0).show();
							cashing_sh();	
							return
						}
					}
					if(Type==1){
						if(!($(".igs").siblings().text()<cashing_Coins2)){
							$(".show").show();
							$(".cashing_fail").eq(0).show();
							cashing_sh();		
								return
						}
					}
					if(Type==2){
						if(!($(".igs").siblings().text()<cashing_Tickets)){
							$(".show").show();
							$(".cashing_fail").eq(0).show();
							cashing_sh();	
							return
						}
					}
					if(Type==3){
						if(!($(".igs").siblings().text()<cashing_Point)){
							$(".show").show();
							$(".cashing_fail").eq(0).show();
							cashing_sh();	
							return
						}
					}
						
					//提交兑换
					var qwe = {};
					qwe[getval]=number_submitted;
					Random = Math.floor(Math.random()*1000);
					var Collate = md5("GiftList"+JSON.stringify(qwe)+
								"Type"+ Type+
							    "Receive"+ Receive+
							    "Address"+ Address+
							    "Phone"+ Phone+
							    "Contact"+ Contact+
							    "UserId"+ "2C1CB150-9F1B-431D-A72F-93BB549631E3"+
							    "BranchId"+ "3D7775B5-33D1-4348-B3AA-4CFD9AEEC0D2"+
							    "OperatorID"+ ""+
							    "ComputerID"+ ""+
							    "Random"+ Random+"huake1212");
							    
					//兑换礼品		    
					myajax({ 
						    "cache-control": "no-cache",
						    "postman-token": "4876e6bc-b277-e2d8-517e-939ec7ae04a6",
						data: {
							"_api":"SaveGiftInfo/SavaGiftInfo",
						    "GiftList":JSON.stringify(qwe),
						    "Type": Type,
						    "Receive": Receive,
						    "Address": Address,
						    "Phone": Phone,
						    "Contact": Contact,
						    "UserId": "2C1CB150-9F1B-431D-A72F-93BB549631E3",
						    "BranchId": "3D7775B5-33D1-4348-B3AA-4CFD9AEEC0D2",
						    "OperatorID": "",
						    "ComputerID": "",
						    "Random": Random,
						    "Collate": Collate,
						}
					},"successfn2");
				});
			}
			
			function successfn2(response){
//		    	console.log(response)
		    	var gifts = JSON.parse(response);
		    	if(gifts.ResultMsg=="兑换成功"){
//		    		console.log(gifts.ResultMsg)
		    		$(".show").show();
		    		$(".cashing_success").show();
		    		setTimeout(function () {
			    		location.href="index.html";
			    	},3000);
			    	cashing_sh();
		    	}
		    }
//			判断异步请求相关回调函数		
			function successfn(response,action){
				if(action=='successfn1'){
					successfn1(response);
					}
					
				if(action=='successfn2'){
					successfn2(response);
					}
				
				if(action=='successfn3'){
					successfn3(response);
				}
				
				if(action=='successfn4'){
					successfn4(response);
				}
			}
			
//			判断提交提示框显示时间
			
			function cashing_sh(){
				if($(".show").css('display') == 'block'){
					setTimeout(function () {
						$(".show").hide();
						$(".show > div").hide();
					},3000);
				}
				if($(".sh_loading").css('display') == 'block'){
					setTimeout(function () {
						$(".sh_loading").hide();
					},3000);
				}
			}
		</script>
	</body>
	
</html>