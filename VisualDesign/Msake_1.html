<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>选择支付方式</title>
		<link rel="stylesheet" href="css/style.css" />
		<link rel="stylesheet" href="css/base.css" />
		<link rel="stylesheet" href="css/confirm_pay.css" />
		<style type="text/css">
			h2{

				margin-bottom:3%;
			}
			.count{
				color:#ff8f40;
				font-size: 1rem;
				font-weight: bold;
			}
			.buyway{
				margin:2.2222% 0 4.4444%;
			}
			.buyway>li{
				overflow: hidden;
			}
			
			.buyway li>:nth-child(1){
				width:14.329%;
				padding:1.5%;
				box-sizing: border-box;
				border-radius:0.3rem;
			}
			.buyway li>:nth-child(2){
				width:60%;
				height:3rem;
				left:20%;

			}
			.buyway .sel{
				width:9.45122%;
				height:2rem;
				padding:5%;
				right:0;
			}
			hr{
				height:1px;
				background-color:#f0f0f0;
				border:none;
			}
			.footer{
				padding:4.44444%;
			}
			#main .buys {
			    width: 100%;
			    display: inline-block;
			    background-color: #10aeff;
			    color: #fff;
			    font-size: 1.2rem;
			    border-radius: 0.3rem;
			    padding: 3% 5%;
			    margin: 3.04878% 0 8.09756%;
			}
			
			/*交易结果窗口样式*/
			.show{
	    		/*display: none;*/
	    		text-align: center;
	    		width: 100%;
	    		padding-top: 70%;
	    		padding-bottom: 130%;
	    		position: fixed;
	    		top:0;
	    		background-color: rgba(0,0,0,0);
	    		z-index: 99;
	    	}
	    	.show>div{
	    		width:53%;
	    		background-color:rgba(0,0,0,0.7);
	    	}
	    	.pay_success{
	    		text-align: center;
	    		font-size: 18px;
				color: #000000;
				padding-top: 3%;
				padding-bottom: 3%;
				border-radius: 100px;
				color: #FFFFFF;
				font-weight: bold;
				margin-left: auto;
				margin-right: auto;
	    	}
	    	.pay_fail{
	    		font-size: 18px;
				color: #000000;
				padding-top: 3%;
				padding-bottom: 3%;
				border-radius: 100px;
				color: #FFFFFF;
				font-weight: bold;
				margin-left: auto;
				margin-right: auto;
	    	}
	    	.Money_fail{
	    		font-size: 18px;
				color: #000000;
				padding-top: 3%;
				padding-bottom: 3%;
				border-radius: 100px;
				color: #FFFFFF;
				font-weight: bold;
				margin-left: auto;
				margin-right: auto;
	    	}
	    	.tnav~*:nth-child(2) {
			    padding-top: 16%;
			    background-color: #FFFFFF;
			}
			@media only screen and (min-width: 550px){
				.tnav~*:nth-child(2){
					padding-top: 11%;
					background-color: #FFFFFF;
				}
			}
			@media only screen and (min-width: 380px) and (max-width: 549px) {
				.tnav~*:nth-child(2){
					padding-top: 14%;
					background-color: #FFFFFF;
				}
			}
		</style>
	</head>
	<body>
	
		<div id="main">
			<div class="tnav col">
				<b class="arrow"><span class="ic_leftarrow" data-url="-1"></span> 选择支付方式</b>
				<span class="backmain ic_home"></span>
			</div>
			<p class="count pad">订单总价:￥ </p>
			<ol class="buyway">
				<li class="pad" hidden="">
					<img src="img01/deposit.svg" style="background-color:#ff8f40;" alt="" />
					<div class="pstion">
						<h2>预存款支付</h2>
						<span class="col">使用账号预存款支付</span>
					</div>
					<div class="sel pstion" data-i="0">
						<img src="img/mg03.png" alt="" />
						<img class="moneys_pay" style="display:none" src="img/mg04.png" alt="" />
					</div>
				</li>
				<hr />
				<li class="pad" hidden="">
					<img src="img01/weixinpay.svg" style="background-color:#09bb07" alt="" />
					<div class="pstion">	
						<h2>微信支付</h2>
						<span class="col">使用微信支付，安全快捷</span>
					</div>
					<div class="sel pstion" data-i="1">
						<img src="img/mg03.png" alt="" />
						<img class="wechat_pay" style="display:none" src="img/mg04.png" alt="" />
					</div>
				</li>
			</ol>
			<div class="footer">	
				<button class="buys" data-url="">确认支付</button>
			</div>
			<!--交易浮动层-->
			<div class="ftc_wzsf">
			  	<div class="srzfmm_box">
				    <div class="qsrzfmm_bt clear_wl">
				    	<div class="h_f1" >×</div>
				    	<span class="fl">请输入会员支付密码</span>
				    </div>
				    <div class="zfmmxx_shop">
				      	<div class="mz"></div>
				      	<div class="wxzf_price"></div>
				    </div>
			    <ul class="mm_box">
			     	<li></li>
			      	<li></li>
			      	<li></li>
			     	<li></li>
			      	<li></li>
			      	<li></li>
			    </ul>
				</div>
				<div class="numb_box">
				    <ul class="nub_ggg">
				      	<li><a href="javascript:void(0);">1</a></li>
				      	<li><a href="javascript:void(0);" class="zj_x">2</a></li>
				     	<li><a href="javascript:void(0);">3</a></li>
				      	<li><a href="javascript:void(0);">4</a></li>
				      	<li><a href="javascript:void(0);" class="zj_x">5</a></li>
				      	<li><a href="javascript:void(0);">6</a></li>
				      	<li><a href="javascript:void(0);">7</a></li>
				      	<li><a href="javascript:void(0);" class="zj_x">8</a></li>
				      	<li><a href="javascript:void(0);">9</a></li>
				      	<li><span></span></li>
				      	<li><a href="javascript:void(0);" class="zj_x">0</a></li>
				      	<li><span  class="del" > <img src="img/jftc_18.jpg"   ></span></li>
				    </ul>
				</div>
			  	<div class="hbbj"></div>
			  	<div class="hbbk"></div>
			</div>
			<!--交易结果提示窗口-->
			<div id="show2" class="show" hidden="">
					<div class="pay_success" hidden=""></div>
					<div class="pay_fail" hidden=""></div>
					<div class="Money_fail" hidden="">会员账户余额不足</div>
			</div>
		</div>
		<div class="sh_loading">
			<div class="loading_mengceng"></div>
			<div class="loadEffect">
			    <span></span>
			    <span></span>
			   	<span></span>
			    <span></span>
			    <span></span>
			    <span></span>
			    <span></span>
			    <span></span>
				<!--<p class="loading_tips"></p>-->
			</div>
		</div>
		<script src="js/jquery-1.12.2.min.js" type="text/javascript"></script>
		<script src="http://cdn.bootcss.com/blueimp-md5/1.1.0/js/md5.min.js"></script>  
		<script src="js/base.js" type="text/javascript"></script>
		<script type="text/javascript">
		window.onload=function(){
			var url = location.href;
			var Csale_sign = url.split("?")[1].split(";")[3].split("=")[1];
			if(Csale_sign==0){
				$(".buyway .pad").eq(1).show();
			}else{
				$(".buyway .pad").show();
			}
//			设置一次选取一种方式
			var t2=null;
			$(".sel").click(function(){
				var t1=$(this).attr("data-i");
				if(t2!=t1){
					t2=t1;
					for(var i=0;i<$(".sel").length;i++){
						$(".sel").eq(i).children().eq(0).css("display","inline").end().eq(1).css("display","none");
						if(i==1){		//使用预存款支付时获取预存款余额
							myajax({ 
								"cache-control": "no-cache",
								"postman-token": "898795b5-1a68-8cf5-8358-11e5bae18c60",
								data: {
									"_api":"member_info_by_wechat/GetCustomerInfo",
								    "WechatId": "ospcgwllZQ98DVrhiKhaVcEjL6zc",
								    "BranchId": "3D7775B5-33D1-4348-B3AA-4CFD9AEEC0D2",
								    "Telephone": "",
								    "CustomerNo": ""
								}
							},"successfn2");
						}
					}
				}
				if($(this).children().eq(0).css("display")=="inline"){
					$(this).children().eq(0).css("display","none").end().eq(1).css("display","inline");
				}else{
					$(this).children().eq(1).css("display","none").end().eq(0).css("display","inline");
				}
			});
			
			//出现浮动层
			$(".buys").click(function(){
			//出现使用预存款购买浮动层
				if($(".moneys_pay").css("display") == 'inline'){
					//清除密码样式
					$(".mm_box li").removeClass("mmdd");
					//重置密码
					PrePayPassword = ""
					i=0;
					$(".ftc_wzsf").show();
				}
			});
			
			//确认支付
			//接收PackageId&PackageAmount
			var PackageId = url.split("?")[1].split(";")[0].split("=")[1];
			var PackageAmount = url.split("?")[1].split(";")[1].split("=")[1];
			var PackageName = decodeURI(url.split("?")[1].split(";")[2].split("=")[1]);
			$(".count").text("订单总价:￥ "+PackageAmount);
			$(".mz").text(PackageName);
			$(".wxzf_price").text("￥"+PackageAmount)
			var Random = Math.floor(Math.random()*1000);
			
			$(".nub_ggg li a").click(function(){
				i++
				if(i<=6){
					PrePayPasswords[i] = $(this).text();
					$(".mm_box li").eq(i-1).addClass("mmdd");
					if(i==6){
						if(PreDeposit>PackageAmount){		//判断预存款充足
							
							PrePayPasswords.forEach(function(value,index){
								PrePayPassword = PrePayPassword +value;		//获取用户输入密码
							});
						
							var Collate = md5(		//加密签名
								"WechatPublicId"+""+
								"WechatId"+""+
								"Qty"+"1"+
								"Price"+PackageAmount+
								"BranchId"+"3D7775B5-33D1-4348-B3AA-4CFD9AEEC0D2"+
								"UserId"+"2C1CB150-9F1B-431D-A72F-93BB549631E3"+
								"PrePayPassword"+PrePayPassword+
								"PayType"+"1"+
								"PackageId"+PackageId+
								"Type"+"1"+
								"TicketNo"+""+
								"Random"+Random+
								 "huake1212");
								
							//异步请求调用提交信息
							myajax({ 
								"cache-control": "no-cache",
								"postman-token": "898795b5-1a68-8cf5-8358-11e5bae18c60",
								data: {
									"_api":"Order/Deposit",
								    "WechatPublicId": "",
								    "WechatId": "",
								    "Qty": "1",
								    "Price": PackageAmount,
								    "BranchId": "3D7775B5-33D1-4348-B3AA-4CFD9AEEC0D2",
								    "UserId": "2C1CB150-9F1B-431D-A72F-93BB549631E3",
								    "PrePayPassword": PrePayPassword,
								    "PayType": "1",
								    "PackageId": PackageId,
								    "Type": "1",
								    "TicketNo":"",
								    "Random": Random,
								    "Collate": Collate,
								}
							},"successfn1");
						}else{
							$(".show,.Money_fail").show();
				    		setTimeout(function () {
					    		$(".mm_box li").removeClass("mmdd");
					    		$(".show , .Money_fail").hide();
					    		i=0;
					    		PrePayPassword="";
					    	},3000);
						}
//						return
					};
				}else{
					if(i>6){
						return
					}
				} 
			});
			
			//删除当前键盘值
			$(".nub_ggg li .del").click(function(){
				if(i>0&&i<6){
					i--
					$(".mm_box li").eq(i).removeClass("mmdd");
				}
			});
			//取消输入密码
			$(".h_f1").click(function(){
				$(".ftc_wzsf").hide();
				$(".mm_box li").removeClass("mmdd");
				i=0;
			});
		}
		
		
			//判断异步请求相关回调函数		
			function successfn(response,action){
				if(action=='successfn1'){
					successfn1(response);
				}
					
				if(action=='successfn2'){
					successfn2(response);
				}
			}
			//初始化输入次数与输入键值
			var i = 0;
			var PrePayPassword = "";
			var PrePayPasswords = new Array(6);
			var PreDeposit;
			//购买成功回调函数
		    function successfn1(response){
		    	var pay_information = JSON.parse(response)
		    	//购买成功
		    	if(pay_information.ResultCode==0){
		    		$(".pay_success").text(pay_information.ResultMsg)
		    		$(".show,.pay_success").show();
		    		setTimeout(function () {
			    		$(".show , .pay_success , .ftc_wzsf").hide();
			    		location.href="index.html";
			    	},3000);
		    	}
		    	//购买失败
		    	if(pay_information.ResultCode==-1){
		    		$(".pay_fail").text(pay_information.ResultMsg)
		    		$(".show,.pay_fail").show();
		    		setTimeout(function () {
			    		$(".mm_box li").removeClass("mmdd");
			    		$(".show , .pay_fail").hide();
			    		i=0;
			    		PrePayPassword="";
			    	},3000);
		    	}
		    }
		    //获取预存款余额
		    function successfn2(response){
		    	PreDeposit=JSON.parse(response).Data[0].Money;
		    }
		</script>
	</body>
	
</html>